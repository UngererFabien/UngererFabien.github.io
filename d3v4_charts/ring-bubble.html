<!DOCTYPE html>
<html>
<head>
	<title>Ring to Bubbles Chart</title>
	<script src="https://d3js.org/d3.v4.js"></script>

	<style type="text/css">
		.chart {
			margin: auto;
			width: 1000px;
			height: 1000px;
		}

		.link {
			fill-opacity: 0.5;
			stroke: #000;
		}
	</style>
</head>
<body>
	<div class="chart"></div>

	<script type="text/javascript">
		// Chart script

		var RingBubble = function (el) {
			var margin = {top: 0, right: 0, bottom: 0, left: 0},
				containerNode = d3.select(el).node();

			var width =  containerNode.clientWidth - margin.left - margin.right,
    			height = containerNode.clientHeight - margin.top - margin.bottom,
    			radius = Math.min(width, height)/2;

			var svg = d3.select(el).append('svg')
				.attr('width', width + margin.left + margin.right)
    			.attr('height', height + margin.top + margin.bottom)
    			.append('g')
    				.attr('transform', 'translate('+margin.left+','+margin.top+')');

    		var color = d3.scaleOrdinal(d3.schemeCategory20c);

    		var packDim = radius*1.5;

    		var pack = d3.pack()
    			.size([packDim, packDim])
    			.padding(10);

    		var partition = d3.partition()
    			.size([2*Math.PI, radius*radius]);

    		var innerRadius = radius-30

    		var arc = d3.arc()
    			.startAngle(d => d.x0)
    			.endAngle(d => d.x1)
    			.outerRadius(radius)
    			.innerRadius(innerRadius);

			this.render = function (data) {
				var hierarchy = d3.hierarchy(data)
					.sum(d => d.val);

				var partitionedData = partition(hierarchy);

				var leavesIndexes = {},
					leaves = {children: []};

				partitionedData.leaves().forEach(d => {
					var leaveIndex = leavesIndexes[d.data.id];

					if(typeof(leaveIndex) != 'undefined') {
						leaves.children[leaveIndex].val += d.data.val;
					} else {
						leavesIndexes[d.data.id] = leaves.children.push({
							id: d.data.id,
							val: d.data.val
						}) - 1;
					}
				});

				var leavesHierarchy = d3.hierarchy(leaves)
					.sum(d => d.val);

				var sources = svg.append('g')
					.attr('transform', 'translate(' + width/2 + ',' + height/2 + ')');

				sources.selectAll('.source').data(partitionedData.children)
					.enter().append('path')
						.attr('class', 'source')
						.attr('fill', d => color(d.data.id))
						.attr('d', arc);

				var packGroup = svg.append('g')
					.attr('transform', 'translate(' + width/8 + ',' + height/8 + ')');

				var packedLeaves = pack(leavesHierarchy);

				var circles = packGroup.selectAll('.g-circles')
					.data(packedLeaves.children)
					.enter().append('g')
						.attr('class', 'g-circles')
						.attr('transform', d => 'translate('+d.x+','+d.y+')');

				circles.append('circle')
					.attr('r', d => d.r)
					.attr('fill', d => color(d.data.id));

				var links = svg.append('g')
					// .attr('transform', 'translate(' + width/2 + ',' + height/2 + ')');

				// console.log(packedLeaves);

				function findPackedLeave (id) {
					for (var i = packedLeaves.children.length - 1; i >= 0; i--) {
						var leave = packedLeaves.children[i];

						if(leave.data.id == id) return leave;
					}
				}

				partitionedData.children.forEach(d => {
					d.children.forEach(leave => {
						var link = d3.path();

						console.log(d, leave)

						var packedLeave = findPackedLeave(leave.data.id);

						link.moveTo(packedLeave.x+width/8, packedLeave.y+height/8);

						link.arc(width/2, height/2, innerRadius, leave.x0, leave.x1);

						// link.moveTo(packedLeave.x, packedLeave.y);

						link.closePath();

						links.append('path')
							.attr('d', link)
							.attr('class', 'link')
							.attr('fill', color(leave.data.id));

						// links.append('path')
						// 	.attr('d', arc(leave))
						// 	.attr('class', 'link')
						// 	.attr('fill', '#000');
					});
				});

				return this;
			}

			return this;
		}
	</script>

	<script type="text/javascript">
		// Random Data script
		function rData (nbChildren) {
			var data = {children: []};

			for (var i = 0; i < 5; i++) {
				var source = {id: 'a_'+i, children: []};
				
				for (var j = 0; j < nbChildren; j++) {
					source.children.push({
						id: 't_'+j,
						val: Math.round(Math.random()*1000)+i*100
					});
				}

				data.children.push(source);
			}


			return data;
		}

		new RingBubble('.chart').render(rData(10));
	</script>
</body>
</html>